name: "Consolidated Workflow for BinItRight"

on:
    workflow_dispatch:

jobs:
    unified-scan:
        runs-on: ubuntu-latest
        steps:
            # --- 1. AUTHORIZED CHECKOUT ---
            - name: Checkout Orchestrator & Submodules
              uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GH_PAT }}
                  submodules: "recursive"
                  fetch-depth: 0

            # --- 2. ENVIRONMENT SETUP ---
            - name: Setup Java 21
              uses: actions/setup-java@v3
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Setup Python 3.10
              uses: actions/setup-python@v4
              with:
                  python-version: "3.10"

            # --- 3. BUILD & GENERATE COVERAGE ---
            - name: Build WebApp (Java 21)
              run: |
                  cd BinItRightWebApp
                  chmod +x mvnw
                  # -DskipITs skips Integration Tests (Selenium) but runs Unit Tests (JaCoCo)
                  ./mvnw clean verify -DskipITs

            - name: Build ML (Python)
              run: |
                  cd BinItRightML
                  pip install -r requirements.txt
                  pip install pytest-cov
                  pytest --cov=. --cov-report=xml

            - name: Build MobileApp (Android)
              run: |
                  cd BinItRightMobileApp
                  chmod +x gradlew
                  ./gradlew testDebugUnitTest

            # --- 4. CONSOLIDATED SCA (OWASP Dependency-Check) ---
            - name: Unified SCA Scan
              uses: dependency-check/Dependency-Check_Action@main
              with:
                  project: "BinItRight_Overall"
                  path: "."
                  format: "ALL"
                  out: "reports"

            # --- 5. CONSOLIDATED SAST & QUALITY (SonarCloud) ---
            - name: Unified Sonar Scan
              uses: sonarsource/sonarcloud-github-action@master
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
