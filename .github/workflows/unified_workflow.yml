name: Unified Coverage & Quality Analysis

on:
    workflow_dispatch:

jobs:
    aggregate:
        name: Aggregate & Analyze
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Parent Repo
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0
                  token: ${{ secrets.GH_PAT }}

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            # ==========================================
            # DOWNLOAD COVERAGE ARTIFACTS
            # ==========================================
            - name: Download Android Coverage
              uses: dawidd6/action-download-artifact@v3
              continue-on-error: true
              with:
                  github_token: ${{ secrets.GH_PAT }}
                  workflow: android_cicd.yml
                  repo: ysriser/BinItRightMobileApp
                  name: android-coverage-reports
                  path: BinItRightMobileApp/app/build/reports/jacoco
                  search_artifacts: true
                  check_artifacts: true

            - name: Download Java Coverage
              uses: dawidd6/action-download-artifact@v3
              continue-on-error: true
              with:
                  github_token: ${{ secrets.GH_PAT }}
                  workflow: pr_validation.yml
                  repo: ysriser/BinItRightWebApp
                  name: java-coverage-reports
                  path: BinItRightWebApp/target/site/jacoco
                  search_artifacts: true
                  check_artifacts: true

            - name: Download Python Coverage
              uses: dawidd6/action-download-artifact@v3
              continue-on-error: true
              with:
                  github_token: ${{ secrets.GH_PAT }}
                  workflow: pr_validation.yml
                  repo: ysriser/BinItRightML
                  name: python-coverage-reports
                  path: BinItRightML
                  search_artifacts: true
                  check_artifacts: true

            # ==========================================
            # PATH CORRECTION (The Fix for 0% / Low Coverage)
            # ==========================================
            - name: Fix Coverage XML Paths
              run: |
                  echo "Applying final path patches..."

                  # WEB FIX: Matches the path shown in your screenshot
                  WEB_XML="BinItRightWebApp/target/site/jacoco/jacoco.xml"
                  if [ -f "$WEB_XML" ]; then
                    # This ensures internal paths start with the module folder name
                    sed -i 's|src/main/java|BinItRightWebApp/src/main/java|g' "$WEB_XML"
                    echo "✅ Web paths patched."
                  fi

                  # ML FIX: Aligning the Python coverage
                  ML_XML="BinItRightML/coverage.xml"
                  if [ -f "$ML_XML" ]; then
                    # Python reports often need the <source> tag updated
                    sed -i 's|<source>.*</source>|<source>BinItRightML</source>|g' "$ML_XML"
                    echo "✅ ML paths patched."
                  fi

                  # MOBILE FIX: Double-checking the working one
                  MOBILE_XML="BinItRightMobileApp/app/build/reports/jacoco/jacoco/jacocoTestReport/jacocoTestReport.xml"
                  if [ -f "$MOBILE_XML" ]; then
                    sed -i 's|app/src/main/java|BinItRightMobileApp/app/src/main/java|g' "$MOBILE_XML"
                    echo "✅ Mobile paths patched."
                  fi

            # ==========================================
            # BUILD BINARIES
            # ==========================================
            - name: Compile Java Web App
              run: |
                  if [ -d "BinItRightWebApp" ]; then
                     cd BinItRightWebApp
                     chmod +x mvnw
                     ./mvnw clean compile test-compile dependency:copy-dependencies -DskipTests
                  fi

            # ==========================================
            # SONARCLOUD ANALYSIS
            # ==========================================
            - name: Run SonarCloud Analysis
              uses: SonarSource/sonarqube-scan-action@v5.0.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              with:
                  args: >
                      -Dsonar.verbose=true
                      -Dsonar.projectKey=ysriser_BinItRightOrchestrator
                      -Dsonar.organization=ysriser
