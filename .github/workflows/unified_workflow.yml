name: Unified Coverage & Quality Analysis

on:
    workflow_dispatch:

jobs:
    aggregate:
        name: Aggregate & Analyze
        runs-on: ubuntu-latest

        steps:
            # ==========================================
            # SETUP
            # ==========================================
            - name: Checkout Parent Repo with Submodules
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0
                  token: ${{ secrets.GH_PAT }}

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"
                  cache: "maven"

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            # ==========================================
            # DOWNLOAD COVERAGE ARTIFACTS (Throttling Fix)
            # ==========================================
            - name: Download Reports via GH CLI
              env:
                  GH_TOKEN: ${{ secrets.GH_PAT }}
              run: |
                  echo "Downloading Android Coverage..."
                  gh artifact download --repo ysriser/BinItRightMobileApp --name android-coverage-reports --dir BinItRightMobileApp/app/build/reports/jacoco || echo "âš ï¸ Android reports not found"

                  echo "Downloading Java Coverage..."
                  gh artifact download --repo ysriser/BinItRightWebApp --name java-coverage-reports --dir BinItRightWebApp/target/site/jacoco || echo "âš ï¸ Java reports not found"

                  echo "Downloading Python Coverage..."
                  gh artifact download --repo ysriser/BinItRightML --name python-coverage-reports --dir BinItRightML || echo "âš ï¸ Python reports not found"

            # ==========================================
            # BUILD BINARIES (Required for Java Coverage)
            # ==========================================
            - name: Compile Java Web App & Export Libraries
              run: |
                  if [ -d "BinItRightWebApp" ]; then
                     cd BinItRightWebApp
                     chmod +x mvnw
                     ./mvnw clean compile test-compile dependency:copy-dependencies -DskipTests
                  else
                     echo "âŒ BinItRightWebApp directory not found!"
                     exit 1
                  fi

            # ==========================================
            # DEBUG PATHS (Verify before scanning)
            # ==========================================
            - name: Verify Report Locations
              run: |
                  echo "--- Checking for coverage files ---"
                  find . -name "jacoco.xml"
                  find . -name "jacocoTestReport.xml"
                  find . -name "coverage.xml"

            # ==========================================
            # SONARCLOUD ANALYSIS
            # ==========================================
            - name: Run SonarCloud Analysis
              uses: SonarSource/sonarqube-scan-action@v5.0.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              with:
                  args: >
                      -Dsonar.verbose=true
                      -Dsonar.projectKey=ysriser_BinItRightOrchestrator
                      -Dsonar.organization=ysriser

            # ==========================================
            # RESULTS SUMMARY
            # ==========================================
            - name: Generate Summary
              if: always()
              run: |
                  echo "## ðŸ“Š Unified Coverage Analysis Complete" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… **SonarCloud Dashboard:** https://sonarcloud.io/dashboard?id=ysriser_BinItRightOrchestrator" >> $GITHUB_STEP_SUMMARY
