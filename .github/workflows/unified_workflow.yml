name: Unified Coverage & Quality Analysis

on:
  workflow_dispatch:

jobs:
  aggregate:
    name: Aggregate & Analyze
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Parent Repo
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ==========================================
      # STEP-BY-STEP ARTIFACT DOWNLOADS
      # ==========================================

      # --- MOBILE (Android) ---
      - name: Download Mobile Coverage
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: android_cicd.yml
          repo: ysriser/BinItRightMobileApp
          name: android-coverage-reports
          path: BinItRightMobileApp/app/build/reports/jacoco/jacocoLocalDebugUnitTestReport/
          search_artifacts: true

      - name: Download Mobile Lint
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: android_cicd.yml
          repo: ysriser/BinItRightMobileApp
          name: android-lint-reports
          path: BinItRightMobileApp/app/build/reports/
          search_artifacts: true

      - name: Download Mobile SAST
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: android_cicd.yml
          repo: ysriser/BinItRightMobileApp
          name: android-sast-results
          path: BinItRightMobileApp/
          search_artifacts: true

      - name: Download Mobile SCA
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: android_cicd.yml
          repo: ysriser/BinItRightMobileApp
          name: android-sca-results
          path: BinItRightMobileApp/
          search_artifacts: true

      # --- WEB (Java Spring) ---
      - name: Download Web Coverage
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: pr_validation.yml
          repo: ysriser/BinItRightWebApp
          name: java-coverage-reports
          path: BinItRightWebApp/target/site/jacoco
          search_artifacts: true

      - name: Download Web Lint (Checkstyle)
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: pr_validation.yml
          repo: ysriser/BinItRightWebApp
          name: java-lint-reports
          path: BinItRightWebApp/target/
          search_artifacts: true

      - name: Download Web SAST
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: pr_validation.yml
          repo: ysriser/BinItRightWebApp
          name: java-sast-results
          path: BinItRightWebApp/
          search_artifacts: true

      - name: Download Web SCA
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: pr_validation.yml
          repo: ysriser/BinItRightWebApp
          name: java-sca-results
          path: BinItRightWebApp/target/
          search_artifacts: true

      - name: Download Java DAST Results
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: master_deploy.yml
          repo: ysriser/BinItRightWebApp
          name: java-dast-results
          path: BinItRightWebApp/
          search_artifacts: true

      # --- ML (Python) ---
      - name: Download ML Coverage/Lint
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: pr_validation.yml
          repo: ysriser/BinItRightML
          name: python-coverage-reports
          path: BinItRightML/
          search_artifacts: true

      - name: Download ML Lint
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: pr_validation.yml
          repo: ysriser/BinItRightML
          name: python-lint-reports
          path: BinItRightML/
          search_artifacts: true

      - name: Download ML SAST
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: pr_validation.yml
          repo: ysriser/BinItRightML
          name: python-sast-results
          path: BinItRightML/
          search_artifacts: true

      - name: Download ML SCA
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: pr_validation.yml
          repo: ysriser/BinItRightML
          name: python-sca-results
          path: BinItRightML/
          search_artifacts: true

      - name: Download Python DAST
        uses: dawidd6/action-download-artifact@v3
        continue-on-error: true
        with:
          github_token: ${{ secrets.GH_PAT }}
          workflow: master_deploy.yml
          repo: ysriser/BinItRightML
          name: python-dast-results
          path: BinItRightML/
          search_artifacts: true

      # ==========================================
      # PATH CORRECTION
      # ==========================================
      - name: Fix Report Paths
        run: |
          echo "Aligning paths for SonarCloud..."

          # 1. Java (Checkstyle)
          if [ -d "BinItRightWebApp/target" ]; then
            find BinItRightWebApp/target -name "*.xml" -exec sed -i 's|/home/runner/work/[^/]*/[^/]*/||g' {} +
          fi

          # --- 2. Python (Ruff/Bandit/Coverage) ---
          # Define the specific ML prefix
          ML_PREFIX="/home/runner/work/BinItRightML/BinItRightML/"

          if [ -f "BinItRightML/coverage.xml" ]; then
            echo "✅ Fixing ML Coverage paths..."
            # Strip the absolute runner path
            sed -i "s|$ML_PREFIX||g" BinItRightML/coverage.xml
            # Force the source tag to the current directory relative to the module root
            sed -i 's|<source>.*</source>|<source>.</source>|g' BinItRightML/coverage.xml
          fi

          if [ -d "BinItRightML" ]; then
             find BinItRightML -name "*.json" -exec sed -i "s|$ML_PREFIX||g" {} +
          fi

          # 3. Mobile (Android Lint)
          [ -f "BinItRightMobileApp/app/build/reports/lint-results-localDebug.xml" ] && sed -i 's|/home/runner/work/[^/]*/[^/]*/||g' BinItRightMobileApp/app/build/reports/lint-results-localDebug.xml

          # 4. Global SARIF Fix
          if [ -f "BinItRightMobileApp/results.sarif" ]; then
            mv BinItRightMobileApp/results.sarif BinItRightMobileApp/android-sast.sarif
          fi
          find . -name "*.sarif" -exec sed -i 's|"uri": "file:///home/runner/work/[^/]*/[^/]*/|"uri": "|g' {} +

          [ -d "BinItRightMobileApp" ] && sed -i 's|"uri": "|"uri": "BinItRightMobileApp/|g' BinItRightMobileApp/*.sarif
          [ -d "BinItRightWebApp" ] && sed -i 's|"uri": "|"uri": "BinItRightWebApp/|g' BinItRightWebApp/*.sarif
          [ -d "BinItRightML" ] && sed -i 's|"uri": "|"uri": "BinItRightML/|g' BinItRightML/*.sarif

          # 5. Java Selenium Results Fix
          if [ -d "BinItRightWebApp/target/failsafe-reports" ]; then
            echo "✅ Fixing Selenium Result paths..."
            find BinItRightWebApp/target/failsafe-reports -name "TEST-*.xml" -exec sed -i "s|$WEB_PREFIX||g" {} +
          fi

          echo "Aligning paths and converting DAST format..."

          # 1. Convert Java DAST (Fixes NoSuchFile & IllegalState)
          python3 zap_to_sonar.py BinItRightWebApp/ui-report.json BinItRightWebApp/java-dast-ui.json BinItRightWebApp
          python3 zap_to_sonar.py BinItRightWebApp/api-report.json BinItRightWebApp/java-dast-api.json BinItRightWebApp

          # 2. Convert Python DAST (If applicable)
          python3 zap_to_sonar.py BinItRightML/report_json.json BinItRightML/python-dast.json BinItRightML

          # 3. Align standard Java paths
          WEB_PREFIX="/home/runner/work/BinItRightWebApp/BinItRightWebApp/"
          if [ -d "BinItRightWebApp/target" ]; then
            find BinItRightWebApp/target -name "*.xml" -exec sed -i "s|$WEB_PREFIX||g" {} +
          fi

          echo "✅ All reports ready."

          echo "✅ Path alignment complete."

      # ==========================================
      # COMPILE & SCAN
      # ==========================================
      - name: Compile Java Web App
        run: |
          cd BinItRightWebApp
          chmod +x mvnw
          ./mvnw compile test-compile dependency:copy-dependencies -DskipTests

      - name: Run SonarCloud Analysis
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.verbose=true
            -Dsonar.projectKey=ysriser_BinItRightOrchestrator
            -Dsonar.organization=ysriser
