name: Unified Coverage & Quality Analysis

on:
    workflow_dispatch: # Manual trigger for testing

jobs:
    aggregate:
        name: Aggregate & Analyze
        runs-on: ubuntu-latest

        steps:
            # ==========================================
            # SETUP
            # ==========================================
            - name: Checkout Parent Repo with Submodules
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0
                  token: ${{ secrets.GH_PAT }}

            # Force populate the folders with actual source code
            - name: Update Submodules
              run: |
                  git submodule sync --recursive
                  git submodule update --init --recursive --remote

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Set up Python 3.11
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            # ==========================================
            # DOWNLOAD COVERAGE ARTIFACTS
            # ==========================================
            - name: Download Android Coverage
              uses: dawidd6/action-download-artifact@v3
              continue-on-error: true
              with:
                  github_token: ${{ secrets.GH_PAT }}
                  workflow: android_cicd.yml
                  repo: ysriser/BinItRightMobileApp
                  name: android-coverage-reports
                  path: BinItRightMobileApp/app/build/reports/jacoco
                  search_artifacts: true
                  if_no_artifact_found: warn

            - name: Download Java Coverage
              uses: dawidd6/action-download-artifact@v3
              continue-on-error: true
              with:
                  github_token: ${{ secrets.GH_PAT }}
                  workflow: pr-validation.yml
                  repo: ysriser/BinItRightWebApp
                  name: java-coverage-reports
                  path: BinItRightWebApp/target/site/jacoco
                  search_artifacts: true
                  if_no_artifact_found: warn

            - name: Download Python Coverage
              uses: dawidd6/action-download-artifact@v3
              continue-on-error: true
              with:
                  github_token: ${{ secrets.GH_PAT }}
                  workflow: pr-validation.yml
                  repo: ysriser/BinItRightML
                  name: python-coverage-reports
                  path: BinItRightML
                  search_artifacts: true
                  if_no_artifact_found: warn

            # ==========================================
            # DEBUG & VERIFICATION
            # ==========================================
            - name: Verify Coverage Files
              run: |
                  echo "========================================="
                  echo "ðŸ” Searching for Coverage Reports"
                  echo "========================================="

                  echo ""
                  echo "ðŸ“± Android Coverage:"
                  find BinItRightMobileApp -name "jacocoTestReport.xml" -o -name "lint-results*.xml" | head -5 || echo "  âŒ No Android coverage found"

                  echo ""
                  echo "â˜• Java Coverage:"
                  find BinItRightWebApp -name "jacoco.xml" | head -5 || echo "  âŒ No Java coverage found"

                  echo ""
                  echo "ðŸ Python Coverage:"
                  find BinItRightML -name "coverage.xml" | head -5 || echo "  âŒ No Python coverage found"

                  echo ""
                  echo "========================================="

            # ==========================================
            # SONARCLOUD ANALYSIS
            # ==========================================
            - name: Cache SonarCloud Packages
              uses: actions/cache@v4
              with:
                  path: ~/.sonar/cache
                  key: ${{ runner.os }}-sonar-${{ hashFiles('**/pom.xml', '**/build.gradle.kts') }}
                  restore-keys: ${{ runner.os }}-sonar

            - name: Run SonarCloud Analysis
              uses: SonarSource/sonarqube-scan-action@v5.0.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
              with:
                  args: >
                      -Dsonar.verbose=true
                      -Dsonar.projectKey=ysriser_BinItRightOrchestrator
                      -Dsonar.organization=ysriser

            # ==========================================
            # RESULTS SUMMARY
            # ==========================================
            - name: Generate Summary
              if: always()
              run: |
                  echo "## ðŸ“Š Unified Coverage Analysis Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… **SonarCloud Dashboard:** https://sonarcloud.io/project/overview?id=ysriser_BinItRightOrchestrator" >> $GITHUB_STEP_SUMMARY
